{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "width": 300,
  "height": 300,
  "data": {
      "url": "https://raw.githubusercontent.com/lemon040805/34003568_w10/refs/heads/main/data/drug_type_by_year.csv"
  },
  "params": [
      {
        "name": "Year_selection",
        "value": 2021,
        "bind": {
            "input": "range",
            "min": 2004,
            "max": 2021,
            "step": 1,
            "name": "Year:  "
        }
      }
  ],
  "transform": [
    { "filter": "datum.year == Year_selection" },
    {
      "joinaggregate": [
        { "op": "sum", "field": "value", "as": "total_addicts" }
      ]
    },
    {
      "calculate": "datum.value / datum.total_addicts",
      "as": "percentage"
    }
  ],
  "layer": [
    {
      "encoding": {
        "theta": {"field": "value", "type": "quantitative", "stack": true },
        "color": {
          "field": "drug_type", 
          "type": "nominal",
          "scale":{
            "range": [
              "#e41a1c",
              "#984ea3",
              "#ff7f00",
              "#a6cee3",
              "#377eb8",
              "#a65628",
              "#f0e442"
            ]
          }
        },
        "tooltip": [
          { "field": "year", "title": "Year", "type": "quantitative" },
          { "field": "drug_type", "title": "Type of Drug", "type": "nominal" },
          { "field": "value", "title": "Drug Addicts", "type": "quantitative" },
          { "field": "percentage", "title": "Percentage", "format": ".1%", "type": "quantitative" }
        ]
    },
    "layer": [
      {
      "mark": {"type": "arc", "outerRadius": 80}
      }, 
      {
        "transform": [
          {
            "window": [{"op": "rank", "as": "ranking"}],
            "sort": [{"field": "percentage", "order":
            "descending"}]
          },
          { "filter": "datum.ranking == 1" }
      ],
        "mark": {"type": "text", "radius": 100},
        "encoding": {
          "text": 
            {
              "field": "percentage",
              "type": "quantitative",
              "format": ".1%"
            },
          "tooltip": [
            { "field": "year", "title": "Year", "type": "quantitative" },
            { "field": "drug_type", "title": "Type of Drug", "type": "nominal" },
            { "field": "value", "title": "Drug Addicts", "type": "quantitative" },
          { "field": "percentage", "title": "Percentage", "format": ".1%", "type": "quantitative" }
          ]
        }
      }
      ]
    }
  ]
}